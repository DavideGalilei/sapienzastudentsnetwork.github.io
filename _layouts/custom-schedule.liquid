---
layout: default
---
<script>
    {% include timetable.js %}
</script>

<h1>Orario personalizzato</h1>
<div class="relative" id="main">
    <!-- TODO: customizzare il pulsante con lo stile https://m3.material.io/components/all-buttons -->
    <button class="absolute top-2 right-0 flex items-center gap-2" onclick="openSubjectsDialog()">
        Materie
        <span class="material-symbols-outlined"> add </span>
    </button>

    {{ content }}

    {% assign days = 'Lunedì, Martedì, Mercoledì, Giovedì, Venerdì' | split: ', ' %}
    <div id="custom-schedule">
        <table>
            <thead>
                <tr>
                    <th scope="col" class="font-light">Orario</th>
                    {% for day in days %}
                        <th class="hidden sm:table-cell" scope="col">{{ day }}</th>
                        <th class="table-cell sm:hidden" scope="col">{{ day | slice: 0 }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody class="hidden sm:table-row-group desktop"></tbody>
            <tbody class="table-row-group sm:hidden mobile"></tbody>
        </table>
    </div>

    <h2>Orari per insegnamento</h2>

    {% for subject in site.data.schedules %}
        {% assign code = subject[0] %}
        {% comment %} {% assign degree = subject[1].degree | to_integer %} {% endcomment %}
        {% assign channels = subject[1].channels %}
        {% assign subject_info = site.data.courses[code] %}

        <div id="{{ code }}" class="hidden">
            <h3 id="{{ code | append: '-h3' }}">{{ code }} - {{ subject_info.name }}</h3>

            {% for channel in channels %}
                {% assign channel_id = channel[0] %}
                {% assign days = channel[1] %}

                {% assign first_day = days | first %}
                {% assign first_day_info = first_day[1] %}

                <div id="{{ code }}-{{ channel_id }}" class="hidden">
                    <h4>
                        {% if channel_id != '0' %}
                            Canale {{ channel_id }} -
                        {% endif %}

                        <a href="{{ site.data.teachers[first_day_info.teacherId].teacherPageUrl }}">
                            {{- site.data.teachers[first_day_info.teacherId].teacherName -}}
                        </a>
                    </h4>

                    <table>
                        <thead>
                            <tr>
                                <th scope="col">Giorno</th>
                                <th scope="col">Orario</th>
                                <th scope="col" style="text-align: right">Aula</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day in days %}
                                {% assign name = day[0] %}
                                {% assign info = day[1] %}
                                <tr>
                                    <td>
                                        {% case name %}
                                            {% when 'monday' %}
                                                Lunedì
                                            {% when 'tuesday' %}
                                                Martedì
                                            {% when 'wednesday' %}
                                                Mercoledì
                                            {% when 'thursday' %}
                                                Giovedì
                                            {% when 'friday' %}
                                                Venerdì
                                            {% when 'saturday' %}
                                                Sabato
                                            {% when 'sunday' %}
                                                Domenica
                                        {% endcase %}
                                    </td>
                                    <td>{{ info.hours }}</td>
                                    <td style="text-align: right; width: 100%;">
                                        {% for classroom in info.classrooms %}
                                            {% assign location_id = classroom[0] %}
                                            {% assign location = classroom[1] %}
                                            {% assign mapsUrl = site.data.classrooms[location_id].mapsUrl %}

                                            {% if mapsUrl %}
                                                <a href="{{ mapsUrl }}">{{ location }}</a>
                                            {% else %}
                                                {{ location }}
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endfor %}
        </div>
    {% endfor %}
</div>

<dialog
    class="h-full ml-0 p-4 items-center rounded-r-3xl shadow-xl dark:shadow-2xl dark:shadow-black backdrop:backdrop-blur-sm dark:bg-black dark:text-white"
    id="subjects"
    onclick="closeSubjectsDialog()"
>
    <div class="w-full h-full flex flex-col items-start">
        <button
            class="material-symbols-outlined rounded-full p-2 m-2 hover:bg-gray-100 cursor-pointer"
            onclick="closeSubjectsDialog()"
        >
            menu_open
        </button>

        <div class="w-full h-full mb-4 pr-4 overflow-y-scroll">
            {% for subject in site.data.schedules %}
                {% assign code = subject[0] %}

                {% assign subject_info = site.data.courses[code] %}

                {% assign teachingDegreeProgramCode = subject[1].degree %}

                {% assign subject_description = '['
                    | append: teachingDegreeProgramCode
                    | append: ']'
                    | append: ' '
                    | append: subject_info.shortName
                %}

                {% assign channels = subject[1].channels %}

                {% for channel in channels %}
                    {% assign channel_id = channel[0] %}
                    {% comment %} {% assign schedule = channel[1] %} {% endcomment %}

                    <button
                        id="dialog-{{ code }}-{{ channel_id }}"
                        class="group w-72 h-12 py-1 px-4 flex bg-gray-50 text-black dark:bg-gray-900 dark:text-white mb-2 items-center rounded-full"
                        onclick="event.stopPropagation(); toggleSubject(`{{ code }}-{{ channel_id }}`)"
                    >
                        <span class="w-full truncate text-left">
                            {{ subject_description }}

                            {% if channel_id != '0' %}
                                (Canale {{ channel_id }})
                            {% endif %}
                        </span>
                    </button>
                {% endfor %}
            {% endfor %}
        </div>
    </div>
</dialog>

<script>
    const selectedSubjects = new Set(JSON.parse(localStorage.getItem('selectedSubjects')));

    function toggleSubject(subjectId) {
        if (selectedSubjects.has(subjectId)) {
            let button = document.getElementById('dialog-' + subjectId);
            button.classList.remove('bg-black', 'text-white', 'dark:bg-white', 'dark:text-black');
            button.classList.add('bg-gray-50', 'dark:bg-gray-900', 'dark:text-white');

            let subjectCode = subjectId.split('-')[0];

            // Hide this subject's timetable div only if the subject was not also added with another channel
            let otherSubjectIdsWithSameCode = Array.from(selectedSubjects).filter((item) =>
                item.startsWith(subjectCode),
            );
            if (otherSubjectIdsWithSameCode.length === 1) {
                let subject_div = document.getElementById(subjectCode);
                subject_div.classList.add('hidden');
            }

            let channel_div = document.getElementById(subjectId);
            channel_div.classList.add('hidden');

            selectedSubjects.delete(subjectId);
        } else {
            let button = document.getElementById('dialog-' + subjectId);
            button.classList.remove('bg-gray-50', 'dark:bg-gray-900', 'dark:text-white');
            button.classList.add('bg-black', 'text-white', 'dark:bg-white', 'dark:text-black');

            let subjectCode = subjectId.split('-')[0];
            let subject_div = document.getElementById(subjectCode);
            subject_div.classList.remove('hidden');

            let channel_div = document.getElementById(subjectId);
            channel_div.classList.remove('hidden');

            selectedSubjects.add(subjectId);
        }

        localStorage.setItem('selectedSubjects', JSON.stringify(Array.from(selectedSubjects)));

        fillTimetable('custom-schedule', Array.from(selectedSubjects));
    }

    addEventListener('DOMContentLoaded', () => {
        for (const subjectId of selectedSubjects) {
            const button = document.getElementById('dialog-' + subjectId);
            button.classList.remove('bg-gray-50', 'dark:bg-gray-900', 'dark:text-white');
            button.classList.add('bg-black', 'text-white', 'dark:bg-white', 'dark:text-black');

            let subjectCode = subjectId.split('-')[0];
            let subject_div = document.getElementById(subjectCode);
            subject_div.classList.remove('hidden');

            let channel_div = document.getElementById(subjectId);
            channel_div.classList.remove('hidden');
        }

        fillTimetable('custom-schedule', Array.from(selectedSubjects));
    });

    function openSubjectsDialog() {
        document.getElementById('subjects').showModal();
    }

    function closeSubjectsDialog() {
        document.getElementById('subjects').close();
    }
</script>
